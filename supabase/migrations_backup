-- ============================================
-- CLEAN INITIAL SCHEMA - Değer360
-- ============================================
-- Consolidated migration reflecting current production schema.
-- Use this for fresh Supabase projects. Replace old migrations with this file.
--
-- Tables: customers, cases, documents, notifications, user_auth,
--         admin_checklist, case_admins, skipped_documents
-- ============================================

-- Extensions (if not already enabled)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================
-- 1. CORE FUNCTIONS
-- ============================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;

CREATE OR REPLACE FUNCTION generate_dosya_takip_numarasi()
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
DECLARE
  new_number TEXT;
  exists_check BOOLEAN;
BEGIN
  LOOP
    new_number := LPAD((FLOOR(RANDOM() * 900000) + 100000)::TEXT, 6, '0');
    SELECT EXISTS(SELECT 1 FROM customers WHERE dosya_takip_numarasi = new_number) INTO exists_check;
    IF NOT exists_check THEN
      RETURN new_number;
    END IF;
  END LOOP;
END;
$$;

CREATE OR REPLACE FUNCTION auto_assign_dosya_takip_numarasi()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
BEGIN
  IF NEW.dosya_takip_numarasi IS NULL THEN
    NEW.dosya_takip_numarasi := generate_dosya_takip_numarasi();
  END IF;
  RETURN NEW;
END;
$$;

-- ============================================
-- 2. TABLES (dependency order)
-- ============================================

-- Customers
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  full_name TEXT NOT NULL,
  address TEXT,
  tc_kimlik TEXT,
  dosya_takip_numarasi TEXT UNIQUE,
  iban TEXT,
  payment_person_name TEXT,
  insurance_company TEXT,
  is_sample BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON COLUMN customers.insurance_company IS 'Müşterinin sigorta şirketi adı';

-- Cases
CREATE TABLE cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  case_number TEXT UNIQUE NOT NULL,
  status TEXT NOT NULL DEFAULT 'active',
  board_stage TEXT DEFAULT 'basvuru_alindi',
  total_payment_amount NUMERIC,
  notary_and_file_expenses NUMERIC DEFAULT 0,
  insurance_response TEXT CHECK (insurance_response IN ('accepted', 'rejected')),
  vehicle_plate TEXT NOT NULL,
  vehicle_brand_model TEXT NOT NULL,
  accident_date DATE NOT NULL,
  accident_location TEXT,
  damage_amount NUMERIC,
  value_loss_amount NUMERIC,
  fault_rate INTEGER DEFAULT 0,
  estimated_compensation NUMERIC,
  commission_rate INTEGER DEFAULT 20,
  current_stage TEXT DEFAULT 'başvuru',
  assigned_lawyer TEXT,
  start_date TIMESTAMPTZ DEFAULT NOW(),
  estimated_completion_date TIMESTAMPTZ,
  completion_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON COLUMN cases.notary_and_file_expenses IS 'Noter ve dosya masrafları tutarı (TL)';
COMMENT ON COLUMN cases.insurance_response IS 'Sigorta şirketinin başvuruya verdiği cevap: accepted (kabul), rejected (red)';

-- Documents
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID REFERENCES cases(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER,
  file_type TEXT,
  category TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  uploaded_by TEXT DEFAULT 'customer',
  uploaded_by_name TEXT,
  uploaded_at TIMESTAMPTZ DEFAULT NOW(),
  description TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Notifications
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  case_id UUID REFERENCES cases(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  type TEXT DEFAULT 'info',
  read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- User auth (links auth.users to customers)
CREATE TABLE user_auth (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE UNIQUE,
  role TEXT DEFAULT 'customer',
  name TEXT,
  password TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Admin checklist
CREATE TABLE admin_checklist (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID REFERENCES cases(id) ON DELETE CASCADE,
  task_key TEXT NOT NULL,
  title TEXT NOT NULL,
  completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,
  completed_by TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(case_id, task_key)
);

-- Case admins (many-to-many: cases <-> auth.users)
CREATE TABLE case_admins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID REFERENCES cases(id) ON DELETE CASCADE,
  admin_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(case_id, admin_id)
);

-- Skipped documents
CREATE TABLE skipped_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID REFERENCES cases(id) ON DELETE CASCADE,
  category TEXT NOT NULL,
  created_by TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(case_id, category)
);

-- ============================================
-- 3. INDEXES
-- ============================================

CREATE INDEX idx_customers_dosya_takip_numarasi ON customers(dosya_takip_numarasi);
CREATE INDEX idx_customers_is_sample ON customers(is_sample);
CREATE INDEX idx_cases_customer_id ON cases(customer_id);
CREATE INDEX idx_cases_case_number ON cases(case_number);
CREATE INDEX idx_cases_board_stage ON cases(board_stage);
CREATE INDEX idx_documents_case_id ON documents(case_id);
CREATE INDEX idx_notifications_customer_id ON notifications(customer_id);
CREATE INDEX idx_user_auth_name ON user_auth(name);
CREATE INDEX idx_user_auth_password ON user_auth(password) WHERE password IS NOT NULL;
CREATE INDEX idx_admin_checklist_case_id ON admin_checklist(case_id);
CREATE INDEX idx_admin_checklist_completed ON admin_checklist(completed);
CREATE INDEX idx_case_admins_case_id ON case_admins(case_id);
CREATE INDEX idx_case_admins_admin_id ON case_admins(admin_id);
CREATE INDEX idx_skipped_documents_case_id ON skipped_documents(case_id);
CREATE INDEX idx_skipped_documents_category ON skipped_documents(category);

-- ============================================
-- 4. TRIGGERS
-- ============================================

CREATE TRIGGER update_customers_updated_at
  BEFORE UPDATE ON customers FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_auto_assign_dosya_takip_numarasi
  BEFORE INSERT ON customers FOR EACH ROW EXECUTE FUNCTION auto_assign_dosya_takip_numarasi();

CREATE TRIGGER update_cases_updated_at
  BEFORE UPDATE ON cases FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_documents_updated_at
  BEFORE UPDATE ON documents FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_auth_updated_at
  BEFORE UPDATE ON user_auth FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_admin_checklist_updated_at
  BEFORE UPDATE ON admin_checklist FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_case_admins_updated_at
  BEFORE UPDATE ON case_admins FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 5. ROW LEVEL SECURITY
-- ============================================

ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE cases ENABLE ROW LEVEL SECURITY;
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_auth ENABLE ROW LEVEL SECURITY;
ALTER TABLE admin_checklist ENABLE ROW LEVEL SECURITY;
ALTER TABLE case_admins ENABLE ROW LEVEL SECURITY;
ALTER TABLE skipped_documents ENABLE ROW LEVEL SECURITY;

-- Customers: superadmin (excl. sample), admin/lawyer/acente see assigned only; customers see own
CREATE POLICY "Admins can view all customers" ON customers FOR SELECT
  USING (
    (auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin') AND is_sample = false)
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer', 'acente'))
       AND id IN (SELECT DISTINCT c.customer_id FROM cases c
                  INNER JOIN case_admins ca ON c.id = ca.case_id WHERE ca.admin_id = auth.uid()))
  );

CREATE POLICY "Admins can update customers" ON customers FOR UPDATE
  USING (
    (auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin') AND is_sample = false)
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND id IN (SELECT DISTINCT c.customer_id FROM cases c
                  INNER JOIN case_admins ca ON c.id = ca.case_id WHERE ca.admin_id = auth.uid()))
  );

CREATE POLICY "Customers can view own" ON customers FOR SELECT
  USING (auth.uid() IN (SELECT id FROM user_auth WHERE customer_id = customers.id));

-- Cases: superadmin (excl. sample), admin/lawyer/acente see assigned only
CREATE POLICY "Admins can view all cases" ON cases FOR SELECT
  USING (
    (auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
     AND NOT (customer_id IN (SELECT id FROM customers WHERE is_sample = true)))
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer', 'acente'))
       AND id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can insert cases" ON cases FOR INSERT
  WITH CHECK (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can update cases" ON cases FOR UPDATE
  USING (
    (auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
     AND NOT (customer_id IN (SELECT id FROM customers WHERE is_sample = true)))
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Customers can view own cases" ON cases FOR SELECT
  USING (customer_id IN (SELECT customer_id FROM user_auth WHERE id = auth.uid()));

-- Documents
CREATE POLICY "Users can view their case documents" ON documents FOR SELECT
  USING (
    case_id IN (SELECT c.id FROM cases c INNER JOIN user_auth ua ON c.customer_id = ua.customer_id WHERE ua.id = auth.uid())
    OR auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer', 'acente'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Customers can upload documents" ON documents FOR INSERT
  WITH CHECK (
    case_id IN (SELECT c.id FROM cases c INNER JOIN user_auth ua ON c.customer_id = ua.customer_id WHERE ua.id = auth.uid())
    OR auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can update documents" ON documents FOR UPDATE
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can delete documents" ON documents FOR DELETE
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

-- Notifications
CREATE POLICY "Users can view own notifications" ON notifications FOR SELECT
  USING (customer_id IN (SELECT customer_id FROM user_auth WHERE id = auth.uid()));

CREATE POLICY "Users can update own notifications" ON notifications FOR UPDATE
  USING (customer_id IN (SELECT customer_id FROM user_auth WHERE id = auth.uid()))
  WITH CHECK (customer_id IN (SELECT customer_id FROM user_auth WHERE id = auth.uid()));

CREATE POLICY "Admins can insert notifications" ON notifications FOR INSERT
  WITH CHECK (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can delete notifications" ON notifications FOR DELETE
  USING (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

-- User auth
CREATE POLICY "Users can view own auth" ON user_auth FOR SELECT
  USING (id = auth.uid());

CREATE POLICY "Admins can insert user auth" ON user_auth FOR INSERT
  WITH CHECK (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can update user auth" ON user_auth FOR UPDATE
  USING (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

-- Admin checklist
CREATE POLICY "Admins can view all checklists" ON admin_checklist FOR SELECT
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer', 'acente'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can insert checklists" ON admin_checklist FOR INSERT
  WITH CHECK (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can update checklists" ON admin_checklist FOR UPDATE
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

CREATE POLICY "Admins can delete checklists" ON admin_checklist FOR DELETE
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer'))
       AND case_id IN (SELECT case_id FROM case_admins WHERE admin_id = auth.uid()))
  );

-- Case admins
CREATE POLICY "Admins can view case_admins" ON case_admins FOR SELECT
  USING (
    auth.uid() IN (SELECT id FROM user_auth WHERE role = 'superadmin')
    OR (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('admin', 'lawyer', 'acente')) AND admin_id = auth.uid())
  );

CREATE POLICY "Admins can insert case_admins" ON case_admins FOR INSERT
  WITH CHECK (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can update case_admins" ON case_admins FOR UPDATE
  USING (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can delete case_admins" ON case_admins FOR DELETE
  USING (auth.uid() IN (SELECT id FROM user_auth WHERE role IN ('superadmin', 'admin', 'lawyer')));

-- Skipped documents
CREATE POLICY "Admins can view skipped documents" ON skipped_documents FOR SELECT
  USING (EXISTS (SELECT 1 FROM user_auth WHERE id = auth.uid() AND role IN ('superadmin', 'admin', 'lawyer', 'acente')));

CREATE POLICY "Admins can insert skipped documents" ON skipped_documents FOR INSERT
  WITH CHECK (EXISTS (SELECT 1 FROM user_auth WHERE id = auth.uid() AND role IN ('superadmin', 'admin', 'lawyer')));

CREATE POLICY "Admins can delete skipped documents" ON skipped_documents FOR DELETE
  USING (EXISTS (SELECT 1 FROM user_auth WHERE id = auth.uid() AND role IN ('superadmin', 'admin', 'lawyer')));

-- ============================================
-- 6. STORAGE BUCKETS
-- ============================================

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES 
  ('documents', 'documents', false, 52428800, ARRAY['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/webp']::text[]),
  ('case-photos', 'case-photos', false, 52428800, ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp']::text[]),
  ('public-images', 'public-images', true, 10485760, ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp']::text[])
ON CONFLICT (id) DO UPDATE SET
  file_size_limit = EXCLUDED.file_size_limit,
  allowed_mime_types = EXCLUDED.allowed_mime_types;

-- Storage policies (drop first in case of re-run)
DROP POLICY IF EXISTS "Anyone authenticated can view documents" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can upload documents" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can update their documents" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can delete documents" ON storage.objects;
DROP POLICY IF EXISTS "Anyone authenticated can view photos" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can upload photos" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can update photos" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can delete photos" ON storage.objects;

CREATE POLICY "Anyone authenticated can view documents" ON storage.objects FOR SELECT
  USING (bucket_id = 'documents' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can upload documents" ON storage.objects FOR INSERT
  WITH CHECK (bucket_id = 'documents' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can update their documents" ON storage.objects FOR UPDATE
  USING (bucket_id = 'documents' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can delete documents" ON storage.objects FOR DELETE
  USING (bucket_id = 'documents' AND auth.role() = 'authenticated');

CREATE POLICY "Anyone authenticated can view photos" ON storage.objects FOR SELECT
  USING (bucket_id = 'case-photos' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can upload photos" ON storage.objects FOR INSERT
  WITH CHECK (bucket_id = 'case-photos' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can update photos" ON storage.objects FOR UPDATE
  USING (bucket_id = 'case-photos' AND auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can delete photos" ON storage.objects FOR DELETE
  USING (bucket_id = 'case-photos' AND auth.role() = 'authenticated');
